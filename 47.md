NIP-47
======

BIP-47 payment code notification via Nostr DM
-----------------------------------

`draft` `optional` `author:kdmukai`

_Note: People use BIP-47 and PayNyms interchangeably. A PayNym is just a human-friendly identifier in a centralized directory that maps to a user's BIP-47 payment code._

BIP-47 normally requires an onchain tx where Alice notifies Bob that she'll be sending him BIP-47 payments. Alice blinds her BIP-47 payment code and sends it as an `OP_RETURN` to Bob's public BIP-47 notification address.

Because Nostr is built around bitcoin keys, a user can take a public BIP-47 payment code and derive its associated Nostr pubkey (aka NIP-47 pubkey). Note that Bob's NIP-47 pubkey will be different from his main Nostr pubkey, even if he uses the same private key for his bitcoin wallet and for Nostr (not recommended!).

Alice can then send her payment code as a Nostr DM to Bob's NIP-47 pubkey.

The onchain "pollution" of BIP-47's normal notification tx is a legit criticism of BIP-47. NIP-47 would eliminate that problem while still being completely deterministic (as long as the recipient still has the private key that's associated with their BIP-47 payment code, they'd always be able to regain access to their NIP-47 DMs).


## Overview
### Alice notifies Bob
Per usual BIP-47 usage, Alice and Bob have generated their respective BIP-47 payment codes. Bob has published his payment code for anyone to use to send him BIP-47 payments.

Alice wants to notify Bob that she will begin sending him BIP-47 payments.

Alice derives the corresponding NIP-47 pubkey from Bob's BIP-47 public payment code.

Alice can now Nostr DM her BIP-47 payment code to Bob's NIP-47 pubkey. This replaces the BIP-47 onchain notification tx. Alice does not need to blind her payment code in the DM since the content of her DM to Bob won't be publicly exposed.

However, in order to preserve her privacy and not reveal that she is interacting with Bob's NIP-47 pubkey, Alice can use a "burner" Nostr private key to DM the one-time notification to Bob.


### Bob checks his NIP-47 DM notifications
Similar to how Alice can derive Bob's NIP-47 pubkey from his BIP-47 payment code, Bob can derive the Nostr private key associated with his NIP-47 pubkey.

With the associated NIP-47 private key, he can see his NIP-47 notification DMs. Now that Bob can access Alice's new NIP-47 notification DM, he has everything he needs (Alice's BIP-47 payment code) to begin watching for her incoming payments in his bitcoin wallet.

For convenience, Bob's NIP-47 private key can [delegate (NIP-26)](26.md) DM access to his normal Nostr key so he can access his NIP-47 notification DMs without having to juggle keys.


## Example
Test vectors from [BIP-47](https://github.com/bitcoin/bips/blob/master/bip-0047.mediawiki):
```
ALICE_MNEMONIC = "response seminar brave tip suit recall often sound stick owner lottery motion"
ALICE_PAYMENT_CODE = "PM8TJTLJbPRGxSbc8EJi42Wrr6QbNSaSSVJ5Y3E4pbCYiTHUskHg13935Ubb7q8tx9GVbh2UuRnBc3WSyJHhUrw8KhprKnn9eDznYGieTzFcwQRya4GA"

BOB_MNEMONIC = "reward upper indicate eight swift arch injury crystal super wrestle already dentist"
BOB_PAYMENT_CODE = "PM8TJS2JxQ5ztXUpBBRnpTbcUXbUHy2T1abfrb3KkAAtMEGNbey4oumH7Hc578WgQJhPjBxteQ5GHHToTYHE3A1w6p7tU6KSoFmWBVbFGjKPisZDbP97"
```

```
# Resulting NIP-47 test vectors
BOB_NOSTR_PUBKEY = 'npub1fn5w8vzw5gzl7j049x2sv9krmds4k83hw5u93nrqc88xf5t79tvqmnnus7'
BOB_NOSTR_PRIVATE_KEY = ''  # TODO
```


## Python implementation
_Note: Move this to a separate gist?_
```
$ pip install embit nostr
```

### Alice derives Bob's NIP-47 pubkey from his BIP-47 payment code
```python
import nostr
from binascii import 
from embit import base58, ec
from embit.bip32 import HDKey

# Decode Bob's base58 payment code and verify the checksum
raw_payment_code = base58.decode_check(BOB_PAYMENT_CODE)

# Parse the 81-byte payment code format:
#   0x47 0x01 0x00 (sign) (32-byte pubkey) (32-byte chain code) (13 0x00 bytes)
pubkey = ec.PublicKey.from_string(hexlify(raw_payment_code[3:36]))
chain_code = raw_payment_code[36:68]

# Derive the 0th pubkey (normally used to generate the BIP-47 notification addr)
key = HDKey(key=pubkey, chain_code=chain_code)
zeroth_bip47_pubkey = key.derive([0])

# Convert it to a Nostr npub:
nostr.PublicKey(zeroth_bip47_pubkey.xonly()).bech32()
>> 'npub1fn5w8vzw5gzl7j049x2sv9krmds4k83hw5u93nrqc88xf5t79tvqmnnus7'
```


### Bob derives his NIP-47 private key from his bitcoin private key
```python
# TODO
```
